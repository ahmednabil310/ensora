<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" />
  <link rel="stylesheet" href="../../../sass/main.css" />
  <title id="settings">Equipment</title>

</head>

<body>
  <div class="row h-100 m-0">
    <!-- side bar -->
    <div class=" col-2 p-0" id="side-bar-container"></div>
    <!-- main page -->
    <div class="col-10 main-page p-0">
      <!-- navbar -->
      <div id="nav-bar-container"></div>
      <!-- Main Content -->
      <div class="main-content settings-header">
        <!-- header -->
        <div class="d-flex main-content__header justify-content-between settings-title">
          <div class="d-flex">
            <a href="#">
              <img class="back-arrow" src="../../../assets/icon-back-arrow.svg" alt="Back">
            </a>
            <!-- Thumbnail -->
            <div class="header-thumbnail">
              <div class="device-thumbnail device-thumbnail--settings">
                <div>
                  <img src="../../../assets/icon-fans.svg" alt="" />
                  <div class="add-photo-btn">
                    <button class="button-nostyle d-flex justify-content-center align-items-center">
                      <img src="../../../assets/Add photo btn.svg" alt="" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- End Thumbnail -->
            <div class="d-flex flex-column">
              <div class="d-flex">
                <span class="title">
                  Fans
                  <span class="label d-inline-flex align-items-center">
                    <span class="device-subtitle">Automation box A</span>
                  </span>
                </span>
              </div>
              <div class="d-flex align-items-center">
                <div class="card-tags">
                  <div class="tag dark-tag">
                    GreenHouse A
                    <img class="close-icon" src="../../../assets/icon-close.svg" alt="remove">
                  </div>
                </div>
                <div class="add-btn">
                  <button class="btn">
                    <img src="../../../assets/icon-add.svg" alt="Add">
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Graph Options Bar -->
        <div class="graph-options-bar pb row p-0 m-0 shadow-sm">
          <div class="col-12 p-0 d-flex justify-content-between align-items-center">
            <div class="col-md-2 p-0">
              <div class="timeframe-selector">
                <select class="custom-select">
                  <option value="0" selected>Last week</option>
                  <option value="1">Last 5 min</option>
                  <option value="2">Last hour</option>
                  <option value="3">Last 24 hours</option>
                  <option value="3">Last week</option>
                  <option value="3">Last month</option>
                  <option value="3">Select date range</option>
                </select>
              </div>
            </div>
            <div class="graphs-layout d-flex">
              <div class="grid-compact">
                <div class="btn-group grid-compact-switch" role="group">
                  <button type="button" class="btn switch-active">
                    <img src="../../../assets/icon-compact.svg" alt="compact view">
                  </button>
                  <button type="button" class="btn">
                    <img src="../../../assets/icon-grid.svg" alt="grid view">
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End Graph Options Bar -->
      </div>
      <!-- middle section -->
      <div class="row mid-section align-items-center flex-column text-center p-20-40 m-0">
        <div class="row graph-box-container d-flex p-0">
          <!-- Graph Box -->
          <div class="graph-box col-sm-12 col-md-12 p-0">
            <div class="graph-box-header d-flex justify-content-between align-items-center">
              <div class="d-flex align-self-start">
                <img src="../../../assets/icon-grap.svg" alt="grap">
                <p>
                  Temperature&nbsp;
                  <span>(Â°F)</span>
                </p>
              </div>
              <div class="d-flex flex-column">
                <div class="d-flex">
                  <div class="change-mode d-flex justify-content-between">
                    <div class="group-power-mode d-flex">
                      <div class="d-flex flex-column">
                        <span>Power</span>
                        <span>Off</span>
                      </div>
                      <div class="d-flex flex-column">
                        <span>Mode</span>
                        <span class="active">Auto</span>
                      </div>
                    </div>
                    <div class="group-override d-flex flex-column">
                      <p>Override</p>
                      <div class="d-flex">
                        <button class="btn btn-primary">On</button>
                        <button class="btn btn-primary">Off</button>
                        <button class="btn" disabled>Auto</button>
                      </div>
                    </div>
                  </div>
                  <button class="btn btn-light download-btn">
                    <img src="../../../assets/icon-download.svg" alt="Download">
                  </button>
                </div>
              </div>
            </div>
            <div class="graph-box-content">
              <svg id="lettuce-fan-graph"></svg>
              <div class="tooltip-area">
                <div class="tooltip-area__text"></div>
              </div>
              <!-- Graphs Here -->
            </div>
          </div>
          <!-- End Graph Box -->
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
    integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF"
    crossorigin="anonymous"></script>
  <script src="../../../js/page-loader.js"></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
    integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
    crossorigin="anonymous"></script>
  <script>
    const width = document.getElementById("lettuce-fan-graph").parentElement.clientWidth;
    const colors = {
      on: "#71C76A",
      off: "#5B6D83",
      override: "#EC6060",
      auto: "#5AAFE8"
    };

    const textColors = {
      on: "#71C76A",
      off: "#687D8F",
      auto: "#5AAFE8",
      override: "#EC6060"
    }
    var data = [
      {
        name: "on/off",
        values: [
          {
            endDate: "2021/7/16",
            startDate: "2021/7/12",
            state: "off"
          },
          {
            endDate: "2021/7/28",
            startDate: "2021/7/16",
            state: "on"
          },
          {
            endDate: "2021/7/30 12:00",
            startDate: "2021/7/28",
            state: "off"
          },
          {
            endDate: "2021/8/2",
            startDate: "2021/7/30 12:00",
            state: "on"
          },
          {
            endDate: "2021/8/5",
            startDate: "2021/8/2",
            state: "off"
          }
        ]
      },
      {
        name: "auto/override",
        values: [
          {
            endDate: "2021/7/21",
            startDate: "2021/7/12",
            state: "override"
          },
          {
            endDate: "2021/8/5",
            startDate: "2021/7/21",
            state: "auto"
          },
        ]
      }
    ];
    //assuming both starts and ends at the same date
    const minDate = moment(data[0].values[0].startDate);
    const maxDate = moment(data[data.length - 1].values[data[data.length - 1].values.length - 1].endDate);

    //name is for y axis
    //key is for layers (stacks) / value should be in key:value
    var tseries = [];
    data.forEach((d) => {
      const obj = { name: d.name };
      d.values.forEach((v, i) => {
        const key = v.state + i;
        const interval = moment(v.endDate).diff(v.startDate);
        obj[key] = interval;
      })
      tseries.push(obj);
    });

    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    const columns = [...Object.keys(tseries[0]).filter((t) => t !== "name"),
    ...Object.keys(tseries[1]).filter((t) => t !== "name")];

    var margin = ({ top: 10, right: 10, bottom: 30, left: 54 }),
      height = Math.max(data.length, 4) * 23.5 + margin.top + margin.bottom,

      formatValue = x => isNaN(x) ? "N/A" : x.toLocaleString("en"),

      yAxis = g => g
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y).tickSizeOuter(0))
        .call(g => g.selectAll(".domain").remove())
        .call(g => g.selectAll(".tick text")
          .attr("dy", "-1.2em")
          .attr("class", "yaxis-labels")
          .attr("fill", function (d, i) {
            return textColors[d.toLowerCase()];
          }))
        .call(g => g.selectAll(".tick text")
          .attr("dy", function (d, i) {
            if (i === 0)
              return "-0.5em";
            if (i === 1)
              return "-1.8em";
            if (i === 2)
              return "-3.5em";
            return "-5.0em";
          })),

      xAxis = g => g
        .attr("transform", `translate(0,${(height - margin.bottom) / 2 - 7})`)
        .attr("class", "xaxis-labels")
        .call(
          d3.axisBottom(timeScale)
            .ticks(d3.timeDay.filter((d) => d3.timeDay.count(0, d) % 7 === 0))
            .tickFormat(
              (d, i) => moment(d).format("MMM D")
            )
            .tickSizeOuter(0)
        )
        .call(g => g.selectAll(".domain").remove()),

      series = d3.stack()
        .keys(columns)
        .value((obj, key) => obj[key] ? obj[key] : 0)
        (tseries);

    y = d3.scaleBand()
      .domain(["On", "Off", "Auto", "Override"])
      .range([0, height - margin.bottom])
      .padding(0),

      timeScale = x = d3.scaleTime()
        .domain([minDate.toDate(), maxDate.toDate()])
        .range([margin.left, width - margin.right]),

      x = d3.scaleLinear()
        .domain([0, d3.max(series, d => d3.max(d, d => d[1]))])
        .range([margin.left, width - margin.right]);


    const svg = d3.select("#lettuce-fan-graph")
      .attr("viewBox", [0, -margin.top, width, height / 2 + margin.bottom / 2])
      .style("overflow", "visible");


    const tmp = svg.append("g");
    const tmp1 = tmp
      .selectAll("g")
      .data(series)
      .join("g")
      .attr("fill", d => colors[d.key.split(/\d/)[0]])
      .selectAll("rect")
      .data(d => d)
      .join("rect")
      .attr("x", d => x(d[0]))
      .attr("y", (d, i) => (i === 0) ? y("On") : y("Off"))
      .attr("width", d => x(d[1]) - x(d[0]))
      .attr("height", function (d, i) {
        if (i === 0) return y.bandwidth();
        return 19;
      });

    svg.append("g")
      .call(xAxis);

    svg.append("g")
      .call(yAxis);

    var tooltip = d3.select(".tooltip-area")
      .style('opacity', 0);

    const line = svg.append("g")
      .append("line")
      .attr("y1", 0)
      .attr("y2", y.bandwidth() + 19)
      .attr("stroke", "#DFE4EB")
      .style("opacity", 0)

    const mouseover = (event, d) => {
      if (!isEventInElement(event, tmp.node())) {
        tooltip.style('opacity', 0);
        line.style("opacity", 1);
        return;
      }
      tooltip.style("opacity", 1);
      line.style("opacity", 1);
    };

    const mouseleave = (event, d) => {
      tooltip.style('opacity', 0);
      line.style("opacity", 0);
    }

    function isEventInElement(event, element) {
      const rect = element.getBoundingClientRect();
      const x = event.clientX;
      if (x < rect.left || x >= rect.right) return false;
      const y = event.clientY;
      if (y < rect.top || y >= rect.bottom) return false;
      return true;
    }

    const getData = (x) => {
      hoveredData = []
      for (let arr of series) {
        for (let layer of arr) {
          if (layer[0] !== layer[1] && x >= layer[0] && x <= layer[1])
            hoveredData.push(arr.key.split(/\d/)[0]);
        }
      }
      return hoveredData;
    }
    const mousemove = (event, d) => {
      if (!isEventInElement(event, tmp.node())) {
        tooltip.style('opacity', 0);
        line.style("opacity", 0);
        return;
      }

      const text = d3.select('.tooltip-area__text');
      const coord = d3.pointer(event, tmp.node());
      const invertedX = x.invert(coord[0]);
      const hoveredData = getData(invertedX);
      tooltip.style('opacity', 1);
      line.style("opacity", 1);


      text.node().innerHTML = `
      ${moment(minDate).add(invertedX).calendar(null, {
        sameElse: function (now) {
          if (this.years() === now.years()) {
            return "ddd, MMMM D hh:mma"
          }
          return "llll";
        }
      })}<br>
      Power <span class="power-text__${hoveredData[0]}">${capitalizeFirstLetter(hoveredData[0])}</span><br>
      Mode <span class="mode-text__${hoveredData[1]}">${capitalizeFirstLetter(hoveredData[1])}</span><br>
      `;

      const parentTop = d3.select(".graph-box-content").node().getBoundingClientRect().top;
      tooltip
        // .style('transform', `translate(${coord[0]}px, -5vh)`)
        .style('top', tmp.node().getBoundingClientRect().top - parentTop + 60 + 'px')
        .style('left', `${event.pageX - 290}px`);

      line
        .attr('x1', coord[0])
        .attr('x2', coord[0])
    };

    tooltip
      .on("mousemove", mousemove)
      .on("mouseleave", mouseleave)
      .on("mouseover", mouseover)
      ;

    tmp1.on("mousemove", mousemove)
      .on("mouseleave", mouseleave)
      .on("mouseover", mouseover);

    line.on("mousemove", mousemove)
      .on("mouseleave", mouseleave)
      .on("mouseover", mouseover);
  </script>
</body>

</html>